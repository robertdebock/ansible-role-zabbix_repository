---
# tasks file for zabbix_repository

- name: include assert.yml
  import_tasks: assert.yml
  run_once: yes
  delegate_to: localhost

- name: install rpm key
  rpm_key:
    key: "https://repo.zabbix.com/RPM-GPG-KEY-ZABBIX-A14FE591"
    state: present
  when:
    - ansible_pkg_mgr in [ "dnf", "yum", "zypper" ]

- name: install (dnf/yum)
  package:
    name: "{{ zabbix_repository_package }}"
    state: present
  register: zabbix_repository_install_dnf_yum
  when:
    - ansible_pkg_mgr in [ "dnf", "yum" ]

- name: install (apt)
  apt:
    deb: "{{ zabbix_repository_package }}"
  register: zabbix_repository_install_apt
  when:
    - ansible_pkg_mgr == "apt"
  notify:
    - update cache

- name: install (zypper}
  zypper:
    name: "{{ zabbix_repository_package }}"
    state: present
    disable_gpg_check: yes
  register: zabbix_repository_install_zypper
  when:
    - ansible_pkg_mgr == "zypper"

- name: fail when yum/dnf, apt and zypper are skipped
  fail:
    msg: "This system does not support yum, dnf or apt."
  when:
    - zabbix_repository_install_dnf_yum is skipped
    - zabbix_repository_install_apt is skipped
    - zabbix_repository_install_zypper is skipped

- name: create /etc/zabbix
  file:
    path: /etc/zabbix
    state: directory
    mode: "0755"

- name: enable zabbix-frontend
  ini_file:
    path: /etc/yum.repos.d/zabbix.repo
    section: zabbix-frontend
    option: enabled
    value: "1"
    mode: "0644"
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version == "7"

- name: flush handlers
  meta: flush_handlers
